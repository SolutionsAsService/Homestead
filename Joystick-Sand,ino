#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_LEDBackpack.h>

// Create 8x8 matrix object
Adafruit_8x8matrix matrix = Adafruit_8x8matrix();

// Joystick pins
const int joyX = A0;
const int joyY = A1;

// Sand map: 8x8 array
byte sand[8] = {0b00011000, 0b00011000, 0b00011000, 0b00011000,
                0b00011000, 0b00011000, 0b00011000, 0b00011000};

void setup() {
  matrix.begin(0x70); // Default I2C address
  matrix.clear();
  matrix.writeDisplay();
  pinMode(joyX, INPUT);
  pinMode(joyY, INPUT);
}

// Function to shift sand array in X direction
void shiftSandX(int dir) {
  for (int i = 0; i < 8; i++) {
    if (dir > 0) {
      sand[i] <<= 1;
      sand[i] |= 0; // Optional: wraparound 0 or random new sand
    } else if (dir < 0) {
      sand[i] >>= 1;
    }
  }
}

// Function to shift sand array in Y direction
void shiftSandY(int dir) {
  if (dir > 0) {
    for (int i = 7; i > 0; i--) sand[i] = sand[i - 1];
    sand[0] = 0b00000000; // top empty
  } else if (dir < 0) {
    for (int i = 0; i < 7; i++) sand[i] = sand[i + 1];
    sand[7] = 0b00000000; // bottom empty
  }
}

void loop() {
  int xVal = analogRead(joyX); // 0-1023
  int yVal = analogRead(joyY);

  int xDir = 0;
  int yDir = 0;

  // Determine joystick direction with a deadzone
  if (xVal < 400) xDir = -1;
  else if (xVal > 600) xDir = 1;

  if (yVal < 400) yDir = -1;
  else if (yVal > 600) yDir = 1;

  // Move sand
  if (xDir != 0) shiftSandX(xDir);
  if (yDir != 0) shiftSandY(yDir);

  // Display sand
  matrix.clear();
  for (int row = 0; row < 8; row++) {
    for (int col = 0; col < 8; col++) {
      if (sand[row] & (1 << col)) matrix.drawPixel(col, row, LED_ON);
    }
  }
  matrix.writeDisplay();

  delay(150); // Adjust speed
}
